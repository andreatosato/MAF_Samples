@page "/"
@inject AgentService AgentService
@inject IServiceProvider ServiceProvider
@rendermode InteractiveServer
@using Microsoft.Extensions.AI
@using Microsoft.Agents.AI

<PageTitle>Chat - Guida Turistica</PageTitle>

<div class="chat-container">
	<div class="chat-header">
		<h3>Guida Turistica AI</h3>
		<p>Chiedi informazioni su qualsiasi città!</p>
	</div>

	<div class="chat-messages">
		@foreach (var message in messages)
		{
			<div class="message @message.Role">
				<div class="message-content">
					<strong>@(message.Role == "user" ? "Tu" : "Assistente"):</strong>
					<p>@message.Content</p>
				</div>
			</div>
		}
		@if (isLoading)
		{
			<div class="message assistant">
				<div class="message-content">
					<strong>Assistente:</strong>
					<p><em>Sto pensando...</em></p>
				</div>
			</div>
		}
	</div>

	<div class="chat-input">
		<input type="text"
			   class="form-control"
			   placeholder="Scrivi la tua domanda su una città..."
			   @bind="userInput"
			   @bind:event="oninput"
			   @onkeypress="HandleKeyPress"
			   disabled="@isLoading" />
		<button class="btn btn-primary" @onclick="SendMessage" disabled="@(isLoading || string.IsNullOrWhiteSpace(userInput))">
			<span class="bi bi-send"></span> Invia
		</button>
	</div>
</div>

@code {
	private string userInput = "";
	private bool isLoading = false;
	private List<ChatMessage> messages = new();

	private class ChatMessage
	{
		public string Role { get; set; } = "";
		public string Content { get; set; } = "";
	}

	private async Task SendMessage()
	{
		if (string.IsNullOrWhiteSpace(userInput))
			return;

		var question = userInput;
		messages.Add(new ChatMessage { Role = "user", Content = question });
		userInput = "";
		isLoading = true;

		try
		{
			var agent = await AgentService.GetResponses();
			var response = await agent.RunAsync(question);

			var responseText = response.ToString() ?? "Nessuna risposta disponibile.";
			messages.Add(new ChatMessage { Role = "assistant", Content = responseText });
		}
		catch (Exception ex)
		{
			messages.Add(new ChatMessage { Role = "assistant", Content = $"Errore: {ex.Message}" });
		}
		finally
		{
			isLoading = false;
		}
	}

	private async Task HandleKeyPress(KeyboardEventArgs e)
	{
		if (e.Key == "Enter" && !string.IsNullOrWhiteSpace(userInput) && !isLoading)
		{
			await SendMessage();
		}
	}
}

<style>
	.chat-container {
		display: flex;
		flex-direction: column;
		height: 80vh;
		max-width: 100%;
		margin: 2rem auto;
		background-color: #f5f5f5;
		border-radius: 0.5rem;
		box-shadow: 0 4px 6px rgba(0,0,0,0.1);
	}

	.chat-header {
		background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
		color: white;
		padding: 1.5rem;
		text-align: center;
		box-shadow: 0 2px 4px rgba(0,0,0,0.1);
		border-radius: 0.5rem 0.5rem 0 0;
	}

		.chat-header h3 {
			margin: 0;
			font-size: 1.8rem;
		}

		.chat-header p {
			margin: 0.5rem 0 0 0;
			opacity: 0.9;
		}

	.chat-messages {
		flex: 1;
		overflow-y: auto;
		padding: 2rem;
		display: flex;
		flex-direction: column;
		gap: 1rem;
	}

	.message {
		display: flex;
		width: 100%;
	}

		.message.user {
			justify-content: flex-end;
		}

		.message.assistant {
			justify-content: flex-start;
		}

	.message-content {
		max-width: 70%;
		padding: 1rem;
		border-radius: 1rem;
		box-shadow: 0 1px 2px rgba(0,0,0,0.1);
	}

	.message.user .message-content {
		background-color: #667eea;
		color: white;
		border-bottom-right-radius: 0.25rem;
	}

	.message.assistant .message-content {
		background-color: white;
		color: #333;
		border-bottom-left-radius: 0.25rem;
	}

	.message-content strong {
		display: block;
		margin-bottom: 0.5rem;
		font-size: 0.9rem;
	}

	.message-content p {
		margin: 0;
		line-height: 1.5;
		white-space: pre-wrap;
		word-wrap: break-word;
	}

	.chat-input {
		display: flex;
		gap: 0.5rem;
		padding: 1rem;
		background-color: white;
		border-top: 1px solid #ddd;
		box-shadow: 0 -2px 4px rgba(0,0,0,0.05);
		border-radius: 0 0 0.5rem 0.5rem;
	}

		.chat-input input {
			flex: 1;
			border-radius: 2rem;
			padding: 0.75rem 1.25rem;
			border: 1px solid #ddd;
		}

			.chat-input input:focus {
				border-color: #667eea;
				box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
			}

		.chat-input button {
			border-radius: 2rem;
			padding: 0.75rem 1.5rem;
			background-color: #667eea;
			border: none;
			font-weight: 500;
		}

			.chat-input button:hover:not(:disabled) {
				background-color: #5568d3;
			}

			.chat-input button:disabled {
				opacity: 0.6;
				cursor: not-allowed;
			}

	@@media (max-width: 768px) {
		.chat-container {
			height: 90vh;
			margin: 1rem;
		}

		.message-content {
			max-width: 85%;
		}
	}
</style>
